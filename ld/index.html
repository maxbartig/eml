<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wausau Lead Dashboard</title>
    <link rel="stylesheet" href="lead-widget.css" />
    <style>
      .generate-progress-overlay {
        background: rgba(3, 8, 18, 0.58) !important;
        backdrop-filter: blur(10px) saturate(120%) !important;
      }
      .generate-progress-card {
        background: linear-gradient(180deg, rgba(15, 23, 42, 0.96), rgba(10, 18, 34, 0.98)) !important;
        color: #e2e8f0 !important;
        border: 1px solid rgba(255, 255, 255, 0.08) !important;
        box-shadow: 0 30px 90px rgba(8, 15, 28, 0.55) !important;
      }
      .generate-progress-card__percent {
        color: #e2e8f0 !important;
      }
      .generate-progress-card__track {
        background: rgba(148, 163, 184, 0.16) !important;
        border: 1px solid rgba(255, 255, 255, 0.06) !important;
      }
      .generate-progress-card__fill {
        background: linear-gradient(90deg, #16a34a, #22c55e) !important;
      }
      .generate-progress-card__count {
        color: #dbe7fb !important;
      }
      .generate-progress-card__label {
        color: #94a3b8 !important;
      }
      .generate-progress-card__close {
        background: rgba(34, 197, 94, 0.14) !important;
        border-color: rgba(34, 197, 94, 0.5) !important;
        color: #d4ffe1 !important;
      }
      .generate-progress-card__close:hover {
        background: rgba(34, 197, 94, 0.22) !important;
      }
      .generate-progress-card.is-error .generate-progress-card__fill {
        background: linear-gradient(90deg, #ef4444, #f87171) !important;
      }
      .generate-progress-card.is-error .generate-progress-card__close {
        border-color: rgba(248, 113, 113, 0.4) !important;
        background: rgba(248, 113, 113, 0.12) !important;
        color: #fecaca !important;
      }
    </style>
  </head>
  <body>
    <div class="auth-overlay" id="authOverlay" aria-modal="true" role="dialog">
      <div class="auth-overlay__panel">
        <h2>Protected dashboard</h2>
        <p>Only Evergreen Media Labs team members can access these leads.</p>
        <form id="authForm" class="auth-overlay__form">
          <label>
            Username
            <input type="text" name="user" autocomplete="username" required />
          </label>
          <label>
            Password
            <input type="password" name="pass" autocomplete="current-password" required />
          </label>
          <p class="auth-overlay__error" id="authError" aria-live="polite"></p>
          <button type="submit" class="auth-overlay__submit">Unlock dashboard</button>
        </form>
      </div>
    </div>
    <main class="lead-dashboard" data-generate-endpoint="https://eml-production-ec0f.up.railway.app/generate">
        <header class="lead-dashboard__top">
          <div>
            <h1 class="lead-dashboard__title">Evergreen Media Labs</h1>
          </div>
          <div class="lead-dashboard__actions">
            <button class="lead-dashboard__action">Polish</button>
            <div class="lead-dashboard__send-group">
              <button class="lead-dashboard__action" id="sendQueueButton">Send</button>
              <span id="sendStatus" class="lead-dashboard__send-status" aria-live="polite"></span>
            </div>
            <button class="lead-dashboard__action lead-dashboard__action--ghost" id="reloadLeadsButton" type="button">Reload</button>
            <button class="lead-dashboard__action lead-dashboard__action--primary" id="openGenerate">Generate</button>
          </div>
        </header>
        <section class="lead-dashboard__filters">
          <div>
            <label for="search-input">Search</label>
            <div class="lead-dashboard__search">
              <input id="search-input" type="text" placeholder="Search by name, city, or category" />
              <span>⌕</span>
            </div>
          </div>
          <div class="lead-dashboard__tabs">
            <button class="lead-dashboard__tab is-active" data-lead-tab="all">Drafts</button>
            <button class="lead-dashboard__tab" data-lead-tab="sent">Sent</button>
          </div>
        </section>
        <section class="lead-dashboard__mock" data-lead-dashboard>
          <p class="lead-dashboard__empty">Loading leads…</p>
        </section>
      </main>
    <div class="generate-overlay is-hidden" id="generateOverlay">
      <div class="generate-overlay__panel">
        <header class="generate-overlay__header">
          <h2>Queue a search</h2>
          <button type="button" class="generate-overlay__close" id="closeGenerate" aria-label="Close">×</button>
        </header>
        <p class="generate-overlay__subtitle">
          Tell me which niches to hunt and how many businesses per niche.
        </p>
        <p class="generate-overlay__endpoint">
          Active endpoint: <span id="generateEndpointDisplay"></span>
        </p>
        <form id="generateForm" class="generate-overlay__form">
          <div id="generateInputs" class="generate-overlay__inputs"></div>
          <button type="button" id="addGenerateRow" class="generate-overlay__add">
            + Add another niche
          </button>
          <button type="submit" class="generate-overlay__submit">Start generation</button>
          <p class="generate-overlay__result" id="generateResult" aria-live="polite"></p>
        </form>
      </div>
    </div>
    <div class="generate-progress-overlay is-hidden" id="generateProgressOverlay" aria-hidden="true">
      <div class="generate-progress-card" role="status" aria-live="polite">
        <p class="generate-progress-card__percent" id="generateProgressPercent">0%</p>
        <div class="generate-progress-card__track" aria-hidden="true">
          <div class="generate-progress-card__fill" id="generateProgressFill"></div>
        </div>
        <p class="generate-progress-card__count" id="generateProgressCount">0 / 0 leads</p>
        <p class="generate-progress-card__label" id="generateProgressLabel">Waiting to start...</p>
        <button type="button" class="generate-progress-card__close is-hidden" id="generateProgressClose">
          Close and refresh
        </button>
      </div>
    </div>
    <script src="lead-widget.js"></script>
    <script>
      (function () {
        const AUTH_USER = "admin";
        const AUTH_PASS = "LG2608";
        const STORAGE_KEY = "lead-dashboard-auth";
        const overlay = document.getElementById("authOverlay");
        const form = document.getElementById("authForm");
        const errorEl = document.getElementById("authError");

        const showOverlay = () => {
          overlay?.classList.remove("is-hidden");
          document.body.classList.add("auth-locked");
        };

        const hideOverlay = () => {
          overlay?.classList.add("is-hidden");
          document.body.classList.remove("auth-locked");
        };

        const checkStored = () => {
          if (sessionStorage.getItem(STORAGE_KEY) === "true") {
            hideOverlay();
          } else {
            showOverlay();
          }
        };

        checkStored();

        form?.addEventListener("submit", (event) => {
          event.preventDefault();
          const data = new FormData(form);
          const user = data.get("user")?.toString().trim();
          const pass = data.get("pass")?.toString();
          if (user === AUTH_USER && pass === AUTH_PASS) {
            sessionStorage.setItem(STORAGE_KEY, "true");
            hideOverlay();
            errorEl.textContent = "";
          } else {
            errorEl.textContent = "Incorrect username or password.";
          }
        });
      })();
    </script>
    <script>
      (function () {
        const openButton = document.getElementById("openGenerate");
        const overlay = document.getElementById("generateOverlay");
        const closeButton = document.getElementById("closeGenerate");
        const form = document.getElementById("generateForm");
        const inputs = document.getElementById("generateInputs");
        const addRowButton = document.getElementById("addGenerateRow");
        const result = document.getElementById("generateResult");
        const endpointDisplay = document.getElementById("generateEndpointDisplay");
        const dashboard = document.querySelector(".lead-dashboard");
        const progressOverlay = document.getElementById("generateProgressOverlay");
        const progressCard = progressOverlay?.querySelector(".generate-progress-card");
        const progressPercent = document.getElementById("generateProgressPercent");
        const progressFill = document.getElementById("generateProgressFill");
        const progressCount = document.getElementById("generateProgressCount");
        const progressLabel = document.getElementById("generateProgressLabel");
        const progressClose = document.getElementById("generateProgressClose");
        const AUTH_STORAGE = "lead-dashboard-auth";
        let progressPollInterval = null;
        let progressFallbackInterval = null;
        let progressFallbackCurrent = 0;

        const show = () => {
          overlay?.classList.remove("is-hidden");
          document.body.classList.add("auth-locked");
        };

        const hide = () => {
          overlay?.classList.add("is-hidden");
          if (sessionStorage.getItem(AUTH_STORAGE) === "true") {
            document.body.classList.remove("auth-locked");
          }
        };

        const createRow = () => {
          const row = document.createElement("div");
          row.className = "generate-row";
          row.innerHTML = `
            <input type="text" name="niche" placeholder="Category (e.g. landscaping)" required />
            <input type="number" name="count" min="1" value="1" required />
            <button type="button" class="generate-row__remove" aria-label="Remove niche">×</button>
          `;
          row.querySelector(".generate-row__remove")?.addEventListener("click", () => row.remove());
          return row;
        };

        const resetRows = () => {
          inputs.innerHTML = "";
          inputs.appendChild(createRow());
        };

        openButton?.addEventListener("click", (event) => {
          event.preventDefault();
          resetRows();
          result.textContent = "";
          show();
        });

        closeButton?.addEventListener("click", hide);

        overlay?.addEventListener("click", (event) => {
          if (event.target === overlay) {
            hide();
          }
        });

        addRowButton?.addEventListener("click", () => inputs.appendChild(createRow()));

        const buildPayload = () => {
          const rows = Array.from(inputs.querySelectorAll(".generate-row"));
          return rows
            .map((row) => {
              const nicheInput = row.querySelector("input[name='niche']");
              const countInput = row.querySelector("input[name='count']");
              const niche = nicheInput ? nicheInput.value.trim() : "";
              const count = Number((countInput ? countInput.value : "") || 0);
              return { niche, count };
            })
            .filter((entry) => entry.niche && entry.count > 0);
        };

        const getTotalRequested = (payload) =>
          payload.reduce((sum, entry) => sum + Number(entry.count || 0), 0);

        const setStatus = (message, isError = false) => {
          result.textContent = message;
          result.style.color = isError ? "#f87171" : "#d4ffdf";
        };

        const updateProgressUI = (current, total, label) => {
          const safeTotal = Math.max(Number(total) || 0, 0);
          const safeCurrent = Math.max(0, Math.min(Number(current) || 0, safeTotal || Number(current) || 0));
          const percent = safeTotal > 0 ? Math.round((safeCurrent / safeTotal) * 100) : 0;
          if (progressPercent) {
            progressPercent.textContent = `${percent}%`;
          }
          if (progressFill) {
            progressFill.style.width = `${Math.max(0, Math.min(percent, 100))}%`;
          }
          if (progressCount) {
            progressCount.textContent = `${safeCurrent} / ${safeTotal} leads`;
          }
          if (progressLabel) {
            progressLabel.textContent = label || "Generating leads...";
          }
        };

        const stopProgressTracking = () => {
          if (progressPollInterval) {
            clearInterval(progressPollInterval);
            progressPollInterval = null;
          }
          if (progressFallbackInterval) {
            clearInterval(progressFallbackInterval);
            progressFallbackInterval = null;
          }
        };

        const showProgress = (total) => {
          progressFallbackCurrent = 0;
          progressCard?.classList.remove("is-complete", "is-error");
          progressClose?.classList.add("is-hidden");
          updateProgressUI(0, total, "Starting generation...");
          overlay?.classList.add("is-hidden");
          progressOverlay?.classList.remove("is-hidden");
          progressOverlay?.setAttribute("aria-hidden", "false");
          document.body.classList.add("auth-locked");
        };

        const hideProgress = () => {
          stopProgressTracking();
          progressOverlay?.classList.add("is-hidden");
          progressOverlay?.setAttribute("aria-hidden", "true");
          if (sessionStorage.getItem(AUTH_STORAGE) === "true") {
            document.body.classList.remove("auth-locked");
          }
        };

        const showProgressCompletion = (message, isError = false) => {
          stopProgressTracking();
          if (progressLabel) {
            progressLabel.textContent = message;
          }
          progressCard?.classList.toggle("is-complete", !isError);
          progressCard?.classList.toggle("is-error", isError);
          if (progressClose) {
            progressClose.textContent = isError ? "Close" : "Close and refresh";
            progressClose.classList.remove("is-hidden");
          }
        };

        const startFallbackProgress = (total) => {
          if (!total || total <= 0) {
            return;
          }
          if (progressFallbackInterval) {
            clearInterval(progressFallbackInterval);
          }
          progressFallbackInterval = setInterval(() => {
            const cap = Math.max(total - 1, 0);
            if (progressFallbackCurrent >= cap) {
              return;
            }
            progressFallbackCurrent += 1;
            updateProgressUI(progressFallbackCurrent, total, "Generating leads...");
          }, 1200);
        };

        const setLoading = (isLoading) => {
          if (isLoading) {
            addRowButton.setAttribute("disabled", "disabled");
            generateFormSubmit?.setAttribute("disabled", "disabled");
            result.textContent = "Generating now…";
            result.style.color = "#d4d8e5";
          } else {
            addRowButton.removeAttribute("disabled");
            generateFormSubmit?.removeAttribute("disabled");
          }
        };

        const generateFormSubmit = form?.querySelector(".generate-overlay__submit");
        const endpoint = dashboard?.dataset.generateEndpoint || "https://evergreenmedialabs.com/generate";
        const progressEndpoint = endpoint.replace(/\/generate$/, "/generate/progress");

        if (endpointDisplay) {
          endpointDisplay.textContent = endpoint;
        }

        progressClose?.addEventListener("click", () => {
          if (progressCard?.classList.contains("is-complete")) {
            window.location.reload();
            return;
          }
          hideProgress();
        });

        form?.addEventListener("submit", async (event) => {
          event.preventDefault();
          const payload = buildPayload();
          if (!payload.length) {
            setStatus("Give me at least one niche with a quantity.", true);
            return;
          }
          const totalRequested = getTotalRequested(payload);
          setLoading(true);
          showProgress(totalRequested);
          stopProgressTracking();
          progressPollInterval = setInterval(async () => {
            try {
              const progressResponse = await fetch(progressEndpoint, { cache: "no-store" });
              if (!progressResponse.ok) {
                return;
              }
              const progress = await progressResponse.json();
              const total = Number(progress?.total || totalRequested);
              const current = Number(progress?.current || 0);
              const label = progress?.message || "Generating leads...";
              updateProgressUI(current, total || totalRequested, label);
            } catch (pollError) {
              // Keep the popup alive with a local estimate if progress polling is unavailable.
            }
          }, 1000);
          startFallbackProgress(totalRequested);
          try {
            const response = await fetch(endpoint, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });
            const text = await response.text();
            let data;
            try {
              data = text ? JSON.parse(text) : undefined;
            } catch (parseError) {
              throw new Error(`Unexpected response from generator: ${text.slice(0, 120)}`);
            }
            if (!response.ok) {
              throw new Error(data?.error || "Generation failed");
            }
            const finalTotal = Number(data?.requested || totalRequested);
            const finalCurrent = Number(data?.generated ?? data?.count ?? finalTotal);
            updateProgressUI(finalCurrent, finalTotal, data?.message || "Generated leads");
            setStatus("Generated leads. Click close to refresh and view them.");
            showProgressCompletion("Generated leads");
          } catch (error) {
            console.error(error);
            const message = error.message?.includes("Failed to fetch")
              ? "Unable to reach the generator. Double-check the network/Flask service."
              : error.message;
            setStatus(message || "Something went wrong.", true);
            showProgressCompletion(message || "Generation failed", true);
          } finally {
            setLoading(false);
            stopProgressTracking();
          }
        });
      })();
    </script>
  </body>
</html>

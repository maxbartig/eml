<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wausau Lead Dashboard</title>
    <link rel="stylesheet" href="lead-widget.css" />
  </head>
  <body>
    <div class="auth-overlay" id="authOverlay" aria-modal="true" role="dialog">
      <div class="auth-overlay__panel">
        <h2>Protected dashboard</h2>
        <p>Only Evergreen Media Labs team members can access these leads.</p>
        <form id="authForm" class="auth-overlay__form">
          <label>
            Username
            <input type="text" name="user" autocomplete="username" required />
          </label>
          <label>
            Password
            <input type="password" name="pass" autocomplete="current-password" required />
          </label>
          <p class="auth-overlay__error" id="authError" aria-live="polite"></p>
          <button type="submit" class="auth-overlay__submit">Unlock dashboard</button>
        </form>
      </div>
    </div>
    <main class="lead-dashboard" data-generate-endpoint="https://eml-production-ec0f.up.railway.app/generate">
        <header class="lead-dashboard__top">
          <div>
            <h1 class="lead-dashboard__title">Evergreen Media Labs</h1>
          </div>
          <div class="lead-dashboard__actions">
            <button class="lead-dashboard__action">Polish</button>
            <button class="lead-dashboard__action">Send</button>
            <button class="lead-dashboard__action lead-dashboard__action--primary" id="openGenerate">Generate</button>
          </div>
        </header>
        <section class="lead-dashboard__filters">
          <div>
            <label for="search-input">Search</label>
            <div class="lead-dashboard__search">
              <input id="search-input" type="text" placeholder="Search by name, city, or category" />
              <span>⌕</span>
            </div>
          </div>
          <div class="lead-dashboard__filter-buttons">
            <button class="lead-dashboard__filter is-active" data-filter="All">All</button>
            <button class="lead-dashboard__filter" data-filter="Sent">Sent</button>
            <button class="lead-dashboard__filter" data-filter="Approved">Approved</button>
            <button class="lead-dashboard__filter" data-filter="Drafted">Drafted</button>
          </div>
        </section>
        <section class="lead-dashboard__mock" data-lead-dashboard>
          <p class="lead-dashboard__empty">Loading leads…</p>
        </section>
      </main>
    <div class="generate-overlay is-hidden" id="generateOverlay">
      <div class="generate-overlay__panel">
        <header class="generate-overlay__header">
          <h2>Queue a search</h2>
          <button type="button" class="generate-overlay__close" id="closeGenerate" aria-label="Close">×</button>
        </header>
        <p class="generate-overlay__subtitle">
          Tell me which niches to hunt and how many businesses per niche.
        </p>
        <p class="generate-overlay__endpoint">
          Active endpoint: <span id="generateEndpointDisplay"></span>
        </p>
        <form id="generateForm" class="generate-overlay__form">
          <div id="generateInputs" class="generate-overlay__inputs"></div>
          <button type="button" id="addGenerateRow" class="generate-overlay__add">
            + Add another niche
          </button>
          <button type="submit" class="generate-overlay__submit">Start generation</button>
          <p class="generate-overlay__result" id="generateResult" aria-live="polite"></p>
        </form>
      </div>
    </div>
    <script src="lead-widget.js"></script>
    <script>
      (function () {
        const AUTH_USER = "admin";
        const AUTH_PASS = "LG2608";
        const STORAGE_KEY = "lead-dashboard-auth";
        const overlay = document.getElementById("authOverlay");
        const form = document.getElementById("authForm");
        const errorEl = document.getElementById("authError");

        const showOverlay = () => {
          overlay?.classList.remove("is-hidden");
          document.body.classList.add("auth-locked");
        };

        const hideOverlay = () => {
          overlay?.classList.add("is-hidden");
          document.body.classList.remove("auth-locked");
        };

        const checkStored = () => {
          if (sessionStorage.getItem(STORAGE_KEY) === "true") {
            hideOverlay();
          } else {
            showOverlay();
          }
        };

        checkStored();

        form?.addEventListener("submit", (event) => {
          event.preventDefault();
          const data = new FormData(form);
          const user = data.get("user")?.toString().trim();
          const pass = data.get("pass")?.toString();
          if (user === AUTH_USER && pass === AUTH_PASS) {
            sessionStorage.setItem(STORAGE_KEY, "true");
            hideOverlay();
            errorEl.textContent = "";
          } else {
            errorEl.textContent = "Incorrect username or password.";
          }
        });
      })();
    </script>
    <script>
      (function () {
        const openButton = document.getElementById("openGenerate");
        const overlay = document.getElementById("generateOverlay");
        const closeButton = document.getElementById("closeGenerate");
        const form = document.getElementById("generateForm");
        const inputs = document.getElementById("generateInputs");
        const addRowButton = document.getElementById("addGenerateRow");
        const result = document.getElementById("generateResult");
        const endpointDisplay = document.getElementById("generateEndpointDisplay");
        const dashboard = document.querySelector(".lead-dashboard");
        const AUTH_STORAGE = "lead-dashboard-auth";

        const show = () => {
          overlay?.classList.remove("is-hidden");
          document.body.classList.add("auth-locked");
        };

        const hide = () => {
          overlay?.classList.add("is-hidden");
          if (sessionStorage.getItem(AUTH_STORAGE) === "true") {
            document.body.classList.remove("auth-locked");
          }
        };

        const createRow = () => {
          const row = document.createElement("div");
          row.className = "generate-row";
          row.innerHTML = `
            <input type="text" name="niche" placeholder="Category (e.g. landscaping)" required />
            <input type="number" name="count" min="1" value="1" required />
            <button type="button" class="generate-row__remove" aria-label="Remove niche">×</button>
          `;
          row.querySelector(".generate-row__remove")?.addEventListener("click", () => row.remove());
          return row;
        };

        const resetRows = () => {
          inputs.innerHTML = "";
          inputs.appendChild(createRow());
        };

        openButton?.addEventListener("click", (event) => {
          event.preventDefault();
          resetRows();
          result.textContent = "";
          show();
        });

        closeButton?.addEventListener("click", hide);

        overlay?.addEventListener("click", (event) => {
          if (event.target === overlay) {
            hide();
          }
        });

        addRowButton?.addEventListener("click", () => inputs.appendChild(createRow()));

        const buildPayload = () => {
          const rows = Array.from(inputs.querySelectorAll(".generate-row"));
          return rows
            .map((row) => {
              const nicheInput = row.querySelector("input[name='niche']");
              const countInput = row.querySelector("input[name='count']");
              const niche = nicheInput ? nicheInput.value.trim() : "";
              const count = Number((countInput ? countInput.value : "") || 0);
              return { niche, count };
            })
            .filter((entry) => entry.niche && entry.count > 0);
        };

        const setStatus = (message, isError = false) => {
          result.textContent = message;
          result.style.color = isError ? "#f87171" : "#d4ffdf";
        };

        const setLoading = (isLoading) => {
          if (isLoading) {
            addRowButton.setAttribute("disabled", "disabled");
            generateFormSubmit?.setAttribute("disabled", "disabled");
            result.textContent = "Generating now…";
            result.style.color = "#d4d8e5";
          } else {
            addRowButton.removeAttribute("disabled");
            generateFormSubmit?.removeAttribute("disabled");
          }
        };

        const generateFormSubmit = form?.querySelector(".generate-overlay__submit");
        const endpoint = dashboard?.dataset.generateEndpoint || "https://evergreenmedialabs.com/generate";

        if (endpointDisplay) {
          endpointDisplay.textContent = endpoint;
        }

        form?.addEventListener("submit", async (event) => {
          event.preventDefault();
          const payload = buildPayload();
          if (!payload.length) {
            setStatus("Give me at least one niche with a quantity.", true);
            return;
          }
          setLoading(true);
          try {
            const response = await fetch(endpoint, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });
            const text = await response.text();
            let data;
            try {
              data = text ? JSON.parse(text) : undefined;
            } catch (parseError) {
              throw new Error(`Unexpected response from generator: ${text.slice(0, 120)}`);
            }
            if (!response.ok) {
              throw new Error(data?.error || "Generation failed");
            }
            setStatus(data?.message || "Queued search. Refresh the page after completion.");
          } catch (error) {
            console.error(error);
            const message = error.message?.includes("Failed to fetch")
              ? "Unable to reach the generator. Double-check the network/Flask service."
              : error.message;
            setStatus(message || "Something went wrong.", true);
          } finally {
            setLoading(false);
          }
        });
      })();
    </script>
  </body>
</html>
